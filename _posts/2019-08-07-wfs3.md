---
layout: left
title: QGIS Server and WFS3
active: Articles
---

# QGIS Server and WFS3

<hr>
{:.post-icon}
![date]({{ site.baseurl }}/images/posts/calendar.png){:width="18px"} &emsp; *August 07, 2019*

{:.post-icon}
![tags]({{ site.baseurl }}/images/posts/tag.png){:width="18px"} &emsp; *QGIS Server, OGC, WFS3*

{:.post-icon}
![avatar]({{ site.baseurl }}/images/posts/avatar.png){:width="18px"} &emsp; *Paul Blottiere*
<hr>


## Introduction

There are various map servers available in the Open Source world, each with
advantages and disadvantages. <a href="https://mapserver.org/">Map Server</a>
and <a href="http://geoserver.org/">GeoServer</a> are the most famous, but QGIS
provides a map server too, named <a href="https://docs.qgis.org/3.4/en/docs/user_manual/working_with_ogc/server/index.html">QGIS Server</a>.
One of the main advantages of QGIS Server is the possibility to directly
configure the project to serve through QGIS Desktop. Indeed, QGIS Desktop acts
like a WYSIWYG tool because the rendering engine used by QGIS Server is exactly
the same.

QGIS Server provides some classical OGC services like WMS, WFS, WCS or even
WMTS since QGIS 3.4. Certification process is ongoing for WFS 1.1.0 and has
been reached for WMS 1.3.0 since QGIS 3.0. It also has been renewed for the LTR
version 3.4.

<br/>
![OGC Badge]({{ site.baseurl }}/images/posts/wfs3/wms_ogc_badge.png){:class="center-image" width="175px"}
<br/>

And from now on, thanks to the work of
<a href="https://github.com/elpaso">Alessandro Pasotti</a>
in the light of the discussion held on the dedicated
<a href="https://github.com/qgis/QGIS-Enhancement-Proposals/issues/144">QEP</a>,
QGIS Server 3.10 is going to provide WFS 3 support. By the way, an experimental
driver already exists for
<a href="https://gdal.org/drivers/vector/wfs3.html">GDAL</a> and a prototype has
been implemented in
<a href="https://www.geo-solutions.it/blog/wfs3-geoserver/">GeoServer</a>.

Let's take a look to the possibilities given by this
brand-new protocol.


Pour tester, se référer à TODO.
<hr>


## Quick reminder about WFS 1.X

WFS, or Web Feature Service, is an Open Geospatial Consortium protocol aiming
at manipulating vector features (lines, points, polygons, ...).

To interact with a map server implementing WFS 1.X, a HTTP request has to be
sent with particular parameters like a `NAME`{:.inline} for indicating a
specific layer to work on or a `BBOX`{:.inline} to specify an extent.  Of
course, there are numerous parameters, and some map servers, like QGIS Server,
implement custom parameters (meaning parameters not described by the OGC
specifications) to tweak settings.

On top of that, WFS 1.X protocol provides mechanisms to explore a project structure
(layers, output format, extents, ...) or get feature information.  Indeed, it's
possible thanks to the concept of `REQUEST`{:.inline}. The most basic WFS
requests are `GetCapabilities`{:.inline}, `DescribeFeatureType`{:.inline} and
`GetFeature`{:.inline}.

Then, the typical workflow to work with WFS 1.X is to:
1. retrieve the structure of the project thanks to the `GetCapabiltiies`{:.inline} request
2. ask information for a specific feature with a `GetFeature`{:.inline} request

For instance let's consider a QGIS Desktop project with, in particular, a layer
based on <a href="https://data.bretagne.bzh/explore/dataset/recensement-du-patrimoine-culturel-breton/information/?location=14,47.83062,-3.70896&basemap=jawg.streets&dataChart=eyJxdWVyaWVzIjpbeyJjb25maWciOnsiZGF0YXNldCI6InJlY2Vuc2VtZW50LWR1LXBhdHJpbW9pbmUtY3VsdHVyZWwtYnJldG9uIiwib3B0aW9ucyI6e319LCJjaGFydHMiOlt7ImFsaWduTW9udGgiOnRydWUsInR5cGUiOiJjb2x1bW4iLCJmdW5jIjoiQVZHIiwieUF4aXMiOiJvaWQiLCJzY2llbnRpZmljRGlzcGxheSI6dHJ1ZSwiY29sb3IiOiIjNjZjMmE1In1dLCJ4QXhpcyI6Im9pZCIsIm1heHBvaW50cyI6NTAsInNvcnQiOiIifV0sInRpbWVzY2FsZSI6IiIsImRpc3BsYXlMZWdlbmQiOnRydWUsImFsaWduTW9udGgiOnRydWV9">OpenData</a>
indicating the position of Dolmens and Menhirs in Brittany.

<br/>
![OGC Badge]({{ site.baseurl }}/images/posts/wfs3/desktop.png){:class="center-image" width="600px"}
<br/>

Then you can retrieve from QGIS Server the structure of the `.qgz`{:.inline}
project thanks to the next request:

``` bash
$ curl http://qgisserver? \
  SERVICE=WFS \
  &VERSION=1.1.0 \
  &REQUEST=GetCapabilities \
  &PROJECT=/tmp/megaliths.qgz
```

{% capture summary %}`getcapabilities.xml`{:.inline}{% endcapture %}
{% capture details %}
```` xml
This XML file does not appear to have any style information associated with it. The document tree is shown below.
<WFS_Capabilities>
  <ows:ServiceIdentification>
    <ows:ServiceType>WFS</ows:ServiceType>
    <ows:ServiceTypeVersion>1.1.0</ows:ServiceTypeVersion>
    <ows:Fees>conditions unknown</ows:Fees>
    <ows:AccessConstraints>None</ows:AccessConstraints>
  </ows:ServiceIdentification>
  <ows:ServiceProvider/>
  <ows:OperationsMetadata>
    <ows:Operation name="GetCapabilities">
      <ows:DCP>
        <ows:HTTP>
          <ows:Get xlink:href="http://qgisserver?MAP=/tmp/megaliths.qgz"/>
          <ows:Post xlink:href="http://qgisserver?MAP=/tmp/megaliths.qgz"/>
        </ows:HTTP>
      </ows:DCP>
      <ows:Parameter name="service">
        <ows:Value>WFS</ows:Value>
      </ows:Parameter>
      <ows:Parameter name="AcceptVersions">
        <ows:Value>1.1.0</ows:Value>
        <ows:Value>1.0.0</ows:Value>
      </ows:Parameter>
        <ows:Parameter name="AcceptFormats">
        <ows:Value>text/xml</ows:Value>
      </ows:Parameter>
    </ows:Operation>
    <ows:Operation name="DescribeFeatureType">
      <ows:DCP>
        <ows:HTTP>
          <ows:Get xlink:href="http://qgisserver?MAP=/tmp/megaliths.qgz"/>
          <ows:Post xlink:href="http://qgisserver?MAP=/tmp/megaliths.qgz"/>
        </ows:HTTP>
      </ows:DCP>
      <ows:Parameter name="outputFormat">
        <ows:Value>XMLSCHEMA</ows:Value>
        <ows:Value>text/xml; subtype=gml/2.1.2</ows:Value>
        <ows:Value>text/xml; subtype=gml/3.1.1</ows:Value>
      </ows:Parameter>
    </ows:Operation>
    <ows:Operation name="GetFeature">
      <ows:DCP>
        <ows:HTTP>
          <ows:Get xlink:href="http://qgisserver?MAP=/tmp/megaliths.qgz"/>
          <ows:Post xlink:href="http://qgisserver?MAP=/tmp/megaliths.qgz"/>
        </ows:HTTP>
      </ows:DCP>
      <ows:Parameter name="outputFormat">
        <ows:Value>text/xml; subtype=gml/2.1.2</ows:Value>
        <ows:Value>text/xml; subtype=gml/3.1.1</ows:Value>
        <ows:Value>application/vnd.geo+json</ows:Value>
      </ows:Parameter>
      <ows:Parameter name="resultType">
        <ows:Value>results</ows:Value>
        <ows:Value>hits</ows:Value>
      </ows:Parameter>
    </ows:Operation>
    <ows:Operation name="Transaction">
      <ows:DCP>
        <ows:HTTP>
          <ows:Get xlink:href="http://qgisserver?MAP=/tmp/megaliths.qgz"/>
          <ows:Post xlink:href="http://qgisserver?MAP=/tmp/megaliths.qgz"/>
        </ows:HTTP>
      </ows:DCP>
      <ows:Parameter name="inputFormat">
        <ows:Value>text/xml; subtype=gml/2.1.2</ows:Value>
        <ows:Value>text/xml; subtype=gml/3.1.1</ows:Value>
        <ows:Value>application/vnd.geo+json</ows:Value>
      </ows:Parameter>
    </ows:Operation>
  </ows:OperationsMetadata>
  <FeatureTypeList>
    <Operations>
      <Operation>Query</Operation>
    </Operations>
    <FeatureType>
      <Name>Megalithe</Name>
      <Title>Megalithe</Title>
      <DefaultSRS>EPSG:4326</DefaultSRS>
      <OtherSRS>EPSG:2154</OtherSRS>
      <OtherSRS>EPSG:3857</OtherSRS>
      <Operations>
        <Operation>Query</Operation>
      </Operations>
      <OutputFormats>
        <Format>text/xml; subtype=gml/3.1.1</Format>
      </OutputFormats>
      <ows:WGS84BoundingBox dimensions="2">
        <ows:LowerCorner>-5.15087 -5.98386</ows:LowerCorner>
        <ows:UpperCorner>-1.04853 48.8762</ows:UpperCorner>
      </ows:WGS84BoundingBox>
    </FeatureType>
  </FeatureTypeList>
  <ogc:Filter_Capabilities>
    <ogc:Spatial_Capabilities>
      <ogc:GeometryOperands>
        <ogc:GeometryOperand>gml:Point</ogc:GeometryOperand>
        <ogc:GeometryOperand>gml:LineString</ogc:GeometryOperand>
        <ogc:GeometryOperand>gml:Polygon</ogc:GeometryOperand>
        <ogc:GeometryOperand>gml:Envelope</ogc:GeometryOperand>
      </ogc:GeometryOperands>
      <ogc:SpatialOperators>
        <ogc:SpatialOperator name="Equals"/>
        <ogc:SpatialOperator name="Disjoint"/>
        <ogc:SpatialOperator name="Touches"/>
        <ogc:SpatialOperator name="Within"/>
        <ogc:SpatialOperator name="Overlaps"/>
        <ogc:SpatialOperator name="Crosses"/>
        <ogc:SpatialOperator name="Intersects"/>
        <ogc:SpatialOperator name="Contains"/>
        <ogc:SpatialOperator name="DWithin"/>
        <ogc:SpatialOperator name="Beyond"/>
        <ogc:SpatialOperator name="BBOX"/>
      </ogc:SpatialOperators>
    </ogc:Spatial_Capabilities>
    <ogc:Scalar_Capabilities>
      <ogc:LogicalOperators/>
        <ogc:ComparisonOperators>
        <ogc:ComparisonOperator>LessThan</ogc:ComparisonOperator>
        <ogc:ComparisonOperator>GreaterThan</ogc:ComparisonOperator>
        <ogc:ComparisonOperator>LessThanEqualTo</ogc:ComparisonOperator>
        <ogc:ComparisonOperator>GreaterThanEqualTo</ogc:ComparisonOperator>
        <ogc:ComparisonOperator>EqualTo</ogc:ComparisonOperator>
        <ogc:ComparisonOperator>Like</ogc:ComparisonOperator>
        <ogc:ComparisonOperator>Between</ogc:ComparisonOperator>
      </ogc:ComparisonOperators>
    </ogc:Scalar_Capabilities>
    <ogc:Id_Capabilities>
      <ogc:FID/>
    </ogc:Id_Capabilities>
  </ogc:Filter_Capabilities>
</WFS_Capabilities>
````
{% endcapture %}

<details>
  <summary>{{ summary | markdownify | remove: '<p>' | remove: '</p>' }}</summary>
  {{ details | markdownify }}
</details>

<br/> Upon closer inspection, we may note that only a layer named `Megaliths`{:.inline}
is available, which is consistent with the server configuration set up in
`Project/Properties...`{:.inline}:

<br/>
![OGC Badge]({{ site.baseurl }}/images/posts/wfs3/settings.png){:class="center-image" width="600px"}
<br/>

Then, we know which layer is available and on which extent. This way, we may
obtain information for a specific feature:

``` bash
$ curl http://qgisserver? \
  SERVICE=WFS \
  &VERSION=1.1.0 \
  &REQUEST=GetFeature \
  &PROJECT=/tmp/megaliths.qgz \
  &TYPENAME=Megaliths \
  &MAXFEATURES=3 \
  &SRSNAME=EPSG:2154 \
  &PROPERTYNAME=denomination,url \
  &BBOX=191617.5,6762287.0,209565.0,6772826.7 \
  &EXP_FILTER="denomination"='menhir'
```

{% capture summary %}`getfeature.xml`{:.inline}{% endcapture %}
{% capture details %}
```` xml
<wfs:FeatureCollection>
  <gml:boundedBy>
    <gml:Envelope srsName="EPSG:4326">
      <gml:lowerCorner>-3.79480658 47.76399383</gml:lowerCorner>
      <gml:upperCorner>-3.56774131 47.87216407</gml:upperCorner>
    </gml:Envelope>
  </gml:boundedBy>
  <gml:featureMember>
    <qgs:Megaliths gml:id="Megaliths.15454">
      <qgs:denomination>menhir</qgs:denomination>
      <qgs:url>
        http://kartenn.region-bretagne.fr/ws/recensement/detail.php?id=divi23_195851
      </qgs:url>
    </qgs:Megaliths>
  </gml:featureMember>
  <gml:featureMember>
    <qgs:Megaliths gml:id="Megaliths.30909">
      <qgs:denomination>menhir</qgs:denomination>
      <qgs:url>
        http://kartenn.region-bretagne.fr/ws/recensement/detail.php?id=dev17012017_234024
      </qgs:url>
    </qgs:Megaliths>
  </gml:featureMember>
  <gml:featureMember>
    <qgs:Megaliths gml:id="Megaliths.32185">
      <qgs:denomination>menhir</qgs:denomination>
      <qgs:url>
        http://kartenn.region-bretagne.fr/ws/recensement/detail.php?id=divi23_200251
      </qgs:url>
    </qgs:Megaliths>
  </gml:featureMember>
</wfs:FeatureCollection>
````
{% endcapture %}

<details>
  <summary>{{ summary | markdownify | remove: '<p>' | remove: '</p>' }}</summary>
  {{ details | markdownify }}
</details>

<hr>

## WFS 3 novelties

TODO
<hr>

## Basic usage with QGIS Server

TODO
<hr>


## Custom template

TODO
<hr>


## Conclusion

Et WFS 2 dans tout ça?

TODO

<br/>
<br/>
<br/>
<br/>
